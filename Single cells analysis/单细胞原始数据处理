#!/bin/bash

# ================= 稳健版配置区域 =================
WORK_DIR="/mnt/windowsdata/qiuzerui/sra"
FQ_DIR="/home/zerui/scfq"
REF_PATH="/mnt/windowsdata/qiuzerui/scannotations/mouse/refdata-gex-mm10-2020-A"
SAMPLES=("SRR35688257" "SRR35688258" "SRR35688259" "SRR35688260" "SRR35688261" "SRR35688262")

# 单样本资源配额 (充分压榨单样本速度)
THREADS=48
MEM_GB=180
ZIP_THREADS=16

mkdir -p "$FQ_DIR"
cd "$FQ_DIR"

# ================= 主程序执行 =================
echo "开始串行处理 6 个样本，当前模式：稳定性优先"

for SAMPLE in "${SAMPLES[@]}"; do
    echo "--------------------------------------------------------"
    echo ">>>> 正在处理样本: $SAMPLE (1/6 当前进行中)"
    
    # 1. SRA 转 FASTQ
    if [ ! -f "$FQ_DIR/${SAMPLE}_S1_L001_R1_001.fastq.gz" ]; then
        echo "[$SAMPLE] 步骤 1: 正在将 SRA 转换为 FASTQ..."
        # 串行模式下 -t 依然指向 $FQ_DIR
        fasterq-dump --split-files --include-technical \
                     -e $THREADS \
                     -O "$FQ_DIR" \
                     -t "$FQ_DIR/tmp_$SAMPLE" \
                     "$WORK_DIR/$SAMPLE"
        
        echo "[$SAMPLE] 步骤 2: 正在进行多线程高速压缩..."
        # R1 和 R2 同时并行压缩
        pigz -p $ZIP_THREADS "$FQ_DIR/${SAMPLE}_1.fastq" && mv "$FQ_DIR/${SAMPLE}_1.fastq.gz" "$FQ_DIR/${SAMPLE}_S1_L001_R1_001.fastq.gz" &
        pigz -p $ZIP_THREADS "$FQ_DIR/${SAMPLE}_2.fastq" && mv "$FQ_DIR/${SAMPLE}_2.fastq.gz" "$FQ_DIR/${SAMPLE}_S1_L001_R2_001.fastq.gz" &
        wait
        
        # 转换压缩完立即清理
        rm -f "$FQ_DIR/${SAMPLE}_1.fastq" "$FQ_DIR/${SAMPLE}_2.fastq"
        rm -rf "$FQ_DIR/tmp_$SAMPLE"
    else
        echo "[$SAMPLE] FASTQ 文件已存在，跳过转换。"
    fi

    # 2. Cell Ranger Count
    echo "[$SAMPLE] 步骤 3: 正在运行 Cell Ranger 定量..."
    if [ ! -d "Output_${SAMPLE}" ]; then
        cellranger count --id="Output_${SAMPLE}" \
                         --transcriptome="$REF_PATH" \
                         --fastqs="$FQ_DIR" \
                         --sample="$SAMPLE" \
                         --localcores=$THREADS \
                         --localmem=$MEM_GB \
                         --jobmode=local
        
        # 【可选】如果 /home 空间依然紧张，取消下面两行的注释，在跑完 Cell Ranger 后自动删除 FASTQ 文件
        # echo "[$SAMPLE] 分析完成，正在清理压缩的 FASTQ 以节省空间..."
        # rm -f "$FQ_DIR/${SAMPLE}_S1_L001_R1_001.fastq.gz" "$FQ_DIR/${SAMPLE}_S1_L001_R2_001.fastq.gz"
    else
        echo "[$SAMPLE] Output 目录已存在，跳过定量步骤。"
    fi
    
    echo "<<<< 样本 $SAMPLE 处理完毕！"
done

echo "--------------------------------------------------------"
echo "恭喜！所有 6 个样本已按序处理完成。"
